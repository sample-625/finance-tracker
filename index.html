<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #16161f;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: rgba(255, 255, 255, 0.08);
            --radius: 12px;
        }
        .light-theme {
            --bg-primary: #f5f5f7; --bg-secondary: #ffffff; --bg-tertiary: #e8e8ed;
            --bg-card: #ffffff; --text-primary: #1a1a2e; --text-secondary: #64648c;
            --text-muted: #9898b0; --border: rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .app { max-width: 100%; min-height: 100vh; padding-bottom: 85px; }
        .header { padding: 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .header-title { font-size: 22px; font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; padding: 8px 4px 24px; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 6px 2px; color: var(--text-muted); cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-item svg { width: 22px; height: 22px; margin-bottom: 3px; }
        .nav-item span { font-size: 10px; font-weight: 500; }
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin: 12px 16px; border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .balance-card { background: var(--accent-gradient); border: none; }
        .balance-label { font-size: 12px; color: rgba(255,255,255,0.8); }
        .balance-amount { font-size: 28px; font-weight: 700; color: white; font-family: 'Inter', monospace; }
        .balance-row { display: flex; gap: 10px; margin-top: 12px; }
        .balance-stat { background: rgba(255,255,255,0.15); padding: 10px; border-radius: 10px; flex: 1; }
        .balance-stat-label { font-size: 10px; color: rgba(255,255,255,0.7); }
        .balance-stat-value { font-size: 13px; font-weight: 600; color: white; }
        .list-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .list-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 12px; background: var(--bg-tertiary); flex-shrink: 0; }
        .list-info { flex: 1; min-width: 0; }
        .list-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .list-value { font-size: 14px; font-weight: 600; text-align: right; margin-right: 8px; }
        .list-value.income { color: var(--success); }
        .list-value.expense { color: var(--danger); }
        .list-actions { display: flex; gap: 6px; }
        .action-btn { padding: 8px 12px; border: none; background: var(--bg-tertiary); border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .action-btn:hover { background: var(--bg-primary); }
        .action-btn.delete { color: var(--danger); }
        .action-btn.delete:hover { background: rgba(239,68,68,0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 12px 18px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all 0.2s; }
        .btn-primary { background: var(--accent-gradient); color: white; }
        .btn-primary:disabled { opacity: 0.5; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-ghost { background: transparent; color: var(--accent); padding: 8px 12px; }
        .btn-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 54px; height: 54px; border-radius: 50%; background: var(--accent-gradient); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 20px rgba(99,102,241,0.4); z-index: 99; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000; display: flex; align-items: flex-end; }
        .modal { background: var(--bg-secondary); width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; padding: 20px; overflow-y: auto; }
        .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 16px; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .form-input { width: 100%; padding: 12px 14px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 15px; font-family: inherit; }
        .form-input:focus { outline: none; border-color: var(--accent); }
        .form-textarea { min-height: 120px; resize: vertical; }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a0a0b0' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }
        .toggle-group { display: flex; background: var(--bg-tertiary); border-radius: 10px; padding: 4px; }
        .toggle-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-secondary); font-size: 13px; font-weight: 500; border-radius: 8px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .toggle-btn.active { background: var(--accent-gradient); color: white; }
        .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-height: 160px; overflow-y: auto; }
        .cat-item { display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: var(--bg-tertiary); border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .cat-item.selected { border-color: var(--accent); background: rgba(99,102,241,0.1); }
        .cat-item span:first-child { font-size: 20px; }
        .cat-item span:last-child { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-card { background: var(--bg-tertiary); border-radius: 10px; padding: 14px; }
        .stat-label { font-size: 11px; color: var(--text-muted); }
        .stat-value { font-size: 18px; font-weight: 700; margin-top: 4px; }
        .stat-value.positive { color: var(--success); }
        .stat-value.negative { color: var(--danger); }
        .progress-bar { height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--accent-gradient); border-radius: 4px; transition: width 0.3s; }
        .empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }
        .habit-check { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border); margin-right: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .habit-check.done { background: var(--success); border-color: var(--success); }
        .habit-check svg { width: 16px; height: 16px; color: white; opacity: 0; }
        .habit-check.done svg { opacity: 1; }
        .streak { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; color: var(--warning); font-weight: 500; }
        .mood-row { display: flex; justify-content: space-around; padding: 14px; background: var(--bg-tertiary); border-radius: var(--radius); }
        .mood-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .mood-btn.selected { border-color: var(--accent); background: rgba(99,102,241,0.2); transform: scale(1.1); }
        .tab-bar { display: flex; gap: 6px; padding: 0 16px; margin-bottom: 12px; overflow-x: auto; }
        .tab-bar::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 10px 16px; background: var(--bg-tertiary); border: none; border-radius: 20px; color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; white-space: nowrap; transition: all 0.2s; }
        .tab-btn.active { background: var(--accent); color: white; }
        .period-btns { display: flex; gap: 8px; padding: 0 16px; margin-bottom: 12px; }
        .period-btn { padding: 8px 14px; background: var(--bg-tertiary); border: none; border-radius: 8px; color: var(--text-secondary); font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; }
        .period-btn.active { background: var(--accent-gradient); color: white; }
        .bar-chart { display: flex; align-items: flex-end; justify-content: space-between; height: 140px; padding: 0 8px; border-bottom: 1px solid var(--border); }
        .bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .bars { display: flex; gap: 3px; align-items: flex-end; height: 120px; }
        .bar { width: 14px; border-radius: 4px 4px 0 0; min-height: 2px; transition: height 0.3s; }
        .bar.income { background: var(--success); }
        .bar.expense { background: var(--danger); }
        .bar-label { font-size: 10px; color: var(--text-muted); margin-top: 6px; }
        .pie-wrap { display: flex; align-items: center; gap: 20px; padding: 16px 0; }
        .pie { width: 100px; height: 100px; border-radius: 50%; flex-shrink: 0; }
        .pie-legend { flex: 1; }
        .pie-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; }
        .pie-color { width: 12px; height: 12px; border-radius: 3px; }
        .pie-pct { margin-left: auto; font-weight: 500; font-size: 11px; color: var(--text-secondary); }
        .settings-row { display: flex; align-items: center; justify-content: space-between; padding: 14px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 8px; }
        .settings-label { font-size: 14px; font-weight: 500; }
        .toggle-switch { width: 48px; height: 26px; background: var(--bg-primary); border-radius: 13px; position: relative; cursor: pointer; transition: background 0.2s; }
        .toggle-switch.on { background: var(--accent); }
        .toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: left 0.2s; }
        .toggle-switch.on::after { left: 25px; }
        .loading { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .goal-pct { font-size: 12px; font-weight: 600; color: var(--accent); }
        .debt-tags { display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap; }
        .debt-tag { font-size: 10px; padding: 3px 8px; background: var(--bg-primary); border-radius: 4px; color: var(--text-secondary); }
        .calc-result { background: var(--bg-tertiary); border-radius: var(--radius); padding: 20px; margin-top: 16px; text-align: center; }
        .calc-result-value { font-size: 32px; font-weight: 700; color: var(--success); }
        .calc-result-label { font-size: 13px; color: var(--text-secondary); margin-top: 6px; }
        .calc-breakdown { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 16px; }
        .breathing-screen { position: fixed; inset: 0; background: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .breathing-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; width: 44px; height: 44px; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; }
        .breathing-circle { width: 180px; height: 180px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; transition: all 4s ease-in-out; }
        .breathing-circle.inhale { transform: scale(1.4); border-color: rgba(16,185,129,0.8); background: rgba(16,185,129,0.1); }
        .breathing-circle.hold { border-color: rgba(245,158,11,0.8); background: rgba(245,158,11,0.1); }
        .breathing-circle.exhale { transform: scale(1); border-color: rgba(99,102,241,0.8); background: rgba(99,102,241,0.1); }
        .breathing-text { font-size: 24px; font-weight: 300; color: white; }
        .breathing-count { font-size: 14px; color: rgba(255,255,255,0.6); margin-top: 30px; }
        .breathing-controls { display: flex; gap: 16px; margin-top: 40px; }
        .breathing-btn { padding: 14px 36px; border-radius: 30px; border: none; font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit; background: var(--accent-gradient); color: white; }
        .pattern-btns { display: flex; gap: 10px; margin-top: 20px; }
        .pattern-btn { padding: 10px 18px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: white; font-size: 13px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .pattern-btn.active { background: rgba(255,255,255,0.2); border-color: white; }
        .note-card { background: var(--bg-tertiary); border-radius: var(--radius); padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .note-card:hover { background: var(--bg-primary); }
        .note-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
        .note-preview { font-size: 13px; color: var(--text-secondary); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .note-date { font-size: 11px; color: var(--text-muted); margin-top: 8px; }
        .invest-rate { color: var(--success); font-weight: 500; }
        .converted-hint { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// === CONSTANTS ===
const CURRENCIES = {
    fiat: [
        { code: 'USD', symbol: '$', name: '–î–æ–ª–ª–∞—Ä' },
        { code: 'EUR', symbol: '‚Ç¨', name: '–ï–≤—Ä–æ' },
        { code: 'RUB', symbol: '‚ÇΩ', name: '–†—É–±–ª—å' },
        { code: 'UAH', symbol: '‚Ç¥', name: '–ì—Ä–∏–≤–Ω–∞' },
        { code: 'GBP', symbol: '¬£', name: '–§—É–Ω—Ç' },
        { code: 'PLN', symbol: 'z≈Ç', name: '–ó–ª–æ—Ç—ã–π' },
        { code: 'CZK', symbol: 'Kƒç', name: '–ö—Ä–æ–Ω–∞' },
        { code: 'JPY', symbol: '¬•', name: '–ô–µ–Ω–∞' },
        { code: 'CNY', symbol: '¬•', name: '–Æ–∞–Ω—å' },
    ],
    crypto: [
        { code: 'BTC', symbol: '‚Çø', name: 'Bitcoin', isCrypto: true },
        { code: 'ETH', symbol: 'Œû', name: 'Ethereum', isCrypto: true },
        { code: 'USDT', symbol: '‚ÇÆ', name: 'Tether', isCrypto: true },
        { code: 'TON', symbol: 'TON', name: 'Toncoin', isCrypto: true },
        { code: 'SOL', symbol: 'SOL', name: 'Solana', isCrypto: true },
        { code: 'BNB', symbol: 'BNB', name: 'BNB', isCrypto: true },
    ]
};
const ALL_CURRENCIES = [...CURRENCIES.fiat, ...CURRENCIES.crypto];
const CRYPTO_CODES = CURRENCIES.crypto.map(c => c.code);

const CATEGORIES = {
    expense: [
        { id: 'food', name: '–ï–¥–∞', emoji: 'üçî', color: '#ef4444' },
        { id: 'transport', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', emoji: 'üöó', color: '#3b82f6' },
        { id: 'shopping', name: '–ü–æ–∫—É–ø–∫–∏', emoji: 'üõçÔ∏è', color: '#8b5cf6' },
        { id: 'entertainment', name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', emoji: 'üéÆ', color: '#ec4899' },
        { id: 'health', name: '–ó–¥–æ—Ä–æ–≤—å–µ', emoji: 'üíä', color: '#10b981' },
        { id: 'utilities', name: '–ö–æ–º–º—É–Ω–∞–ª–∫–∞', emoji: 'üí°', color: '#f59e0b' },
        { id: 'rent', name: '–ê—Ä–µ–Ω–¥–∞', emoji: 'üè†', color: '#6366f1' },
        { id: 'subscriptions', name: '–ü–æ–¥–ø–∏—Å–∫–∏', emoji: 'üì±', color: '#14b8a6' },
        { id: 'education', name: '–£—á—ë–±–∞', emoji: 'üìö', color: '#a855f7' },
        { id: 'other_exp', name: '–î—Ä—É–≥–æ–µ', emoji: 'üì¶', color: '#64748b' },
    ],
    income: [
        { id: 'salary', name: '–ó–∞—Ä–ø–ª–∞—Ç–∞', emoji: 'üíº', color: '#10b981' },
        { id: 'freelance', name: '–§—Ä–∏–ª–∞–Ω—Å', emoji: 'üíª', color: '#3b82f6' },
        { id: 'investments', name: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', emoji: 'üìà', color: '#8b5cf6' },
        { id: 'gifts_in', name: '–ü–æ–¥–∞—Ä–∫–∏', emoji: 'üéÅ', color: '#f43f5e' },
        { id: 'cashback', name: '–ö—ç—à–±–µ–∫', emoji: 'üí∏', color: '#f59e0b' },
        { id: 'other_inc', name: '–î—Ä—É–≥–æ–µ', emoji: '‚ú®', color: '#64748b' },
    ]
};

const MOODS = [
    { id: 1, emoji: 'üò¢' }, { id: 2, emoji: 'üòï' }, { id: 3, emoji: 'üòê' },
    { id: 4, emoji: 'üôÇ' }, { id: 5, emoji: 'üòÑ' },
];

// === CURRENCY API WITH CRYPTO ===
const CurrencyAPI = {
    rates: null,
    lastFetch: null,
    
    async fetchRates() {
        if (this.rates && this.lastFetch && Date.now() - this.lastFetch < 600000) {
            return this.rates;
        }
        
        try {
            // Fetch fiat rates
            const fiatRes = await fetch('https://api.frankfurter.app/latest?from=USD');
            const fiatData = await fiatRes.json();
            
            // Fetch crypto rates from CoinGecko (free API)
            const cryptoRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether,the-open-network,solana,binancecoin&vs_currencies=usd');
            const cryptoData = await cryptoRes.json();
            
            this.rates = {
                USD: 1,
                ...fiatData.rates,
                // Crypto: —Ö—Ä–∞–Ω–∏–º —Å–∫–æ–ª—å–∫–æ USD —Å—Ç–æ–∏—Ç 1 –º–æ–Ω–µ—Ç–∞
                BTC: cryptoData.bitcoin?.usd || 97000,
                ETH: cryptoData.ethereum?.usd || 3400,
                USDT: cryptoData.tether?.usd || 1,
                TON: cryptoData['the-open-network']?.usd || 5.5,
                SOL: cryptoData.solana?.usd || 200,
                BNB: cryptoData.binancecoin?.usd || 700,
            };
            this.lastFetch = Date.now();
        } catch (e) {
            console.error('Rate fetch error:', e);
            // Fallback rates
            if (!this.rates) {
                this.rates = {
                    USD: 1, EUR: 0.92, RUB: 97, UAH: 41, GBP: 0.79, PLN: 4.0, CZK: 23.5, JPY: 157, CNY: 7.3,
                    BTC: 97000, ETH: 3400, USDT: 1, TON: 5.5, SOL: 200, BNB: 700
                };
            }
        }
        return this.rates;
    },
    
    async convert(amount, fromCurrency, toCurrency) {
        if (fromCurrency === toCurrency) return amount;
        const rates = await this.fetchRates();
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ USD
        let usdAmount;
        if (fromCurrency === 'USD') {
            usdAmount = amount;
        } else if (CRYPTO_CODES.includes(fromCurrency)) {
            // –ö—Ä–∏–ø—Ç–∞: amount * —Ü–µ–Ω–∞ –≤ USD
            usdAmount = amount * (rates[fromCurrency] || 1);
        } else {
            // –§–∏–∞—Ç: amount / –∫—É—Ä—Å –∫ USD
            usdAmount = amount / (rates[fromCurrency] || 1);
        }
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ USD –≤ —Ü–µ–ª–µ–≤—É—é –≤–∞–ª—é—Ç—É
        if (toCurrency === 'USD') {
            return usdAmount;
        } else if (CRYPTO_CODES.includes(toCurrency)) {
            // –í –∫—Ä–∏–ø—Ç—É: USD / —Ü–µ–Ω–∞ –º–æ–Ω–µ—Ç—ã
            return usdAmount / (rates[toCurrency] || 1);
        } else {
            // –í —Ñ–∏–∞—Ç: USD * –∫—É—Ä—Å
            return usdAmount * (rates[toCurrency] || 1);
        }
    },
    
    async getRate(fromCurrency, toCurrency) {
        return await this.convert(1, fromCurrency, toCurrency);
    }
};

// === STORAGE WITH MIGRATION ===
const STORAGE_KEY = 'lifeTrackerData';
const OLD_KEYS = ['lifeTrackerV3', 'lifeTrackerV2'];

const storage = {
    async get() {
        let data = null;
        
        // Try current key first
        if (window.Telegram?.WebApp?.CloudStorage) {
            data = await new Promise(r => 
                window.Telegram.WebApp.CloudStorage.getItem(STORAGE_KEY, (e, v) => r(v ? JSON.parse(v) : null))
            );
        } else {
            const v = localStorage.getItem(STORAGE_KEY);
            data = v ? JSON.parse(v) : null;
        }
        
        // If no data, try migration from old keys
        if (!data) {
            for (const oldKey of OLD_KEYS) {
                let oldData = null;
                if (window.Telegram?.WebApp?.CloudStorage) {
                    oldData = await new Promise(r => 
                        window.Telegram.WebApp.CloudStorage.getItem(oldKey, (e, v) => r(v ? JSON.parse(v) : null))
                    );
                } else {
                    const v = localStorage.getItem(oldKey);
                    oldData = v ? JSON.parse(v) : null;
                }
                
                if (oldData) {
                    console.log('Migrating data from', oldKey);
                    data = oldData;
                    // Save to new key
                    await this.set(data);
                    break;
                }
            }
        }
        
        return data;
    },
    
    async set(data) {
        const s = JSON.stringify(data);
        if (window.Telegram?.WebApp?.CloudStorage) {
            return new Promise(r => window.Telegram.WebApp.CloudStorage.setItem(STORAGE_KEY, s, () => r()));
        }
        localStorage.setItem(STORAGE_KEY, s);
    }
};

// === HELPERS ===
const isCrypto = (code) => CRYPTO_CODES.includes(code);

const formatAmount = (amount, currency) => {
    const curr = ALL_CURRENCIES.find(c => c.code === currency);
    const symbol = curr?.symbol || currency;
    
    // –î–ª—è –∫—Ä–∏–ø—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ 6 –∑–Ω–∞–∫–æ–≤
    if (isCrypto(currency)) {
        const formatted = Math.abs(amount).toLocaleString('ru-RU', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 6 
        });
        return `${amount < 0 ? '-' : ''}${symbol}${formatted}`;
    }
    
    // –î–ª—è —Ñ–∏–∞—Ç–∞ - 2 –∑–Ω–∞–∫–∞
    const formatted = Math.abs(amount).toLocaleString('ru-RU', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
    return `${amount < 0 ? '-' : ''}${symbol}${formatted}`;
};

const formatDate = (d) => new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
const formatFullDate = (d) => new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
const today = () => new Date().toISOString().split('T')[0];
const now = () => new Date().toISOString();

const getStreak = (dates) => {
    if (!dates?.length) return 0;
    const sorted = [...dates].sort((a, b) => new Date(b) - new Date(a));
    const t = today(), y = new Date(Date.now() - 86400000).toISOString().split('T')[0];
    if (sorted[0] !== t && sorted[0] !== y) return 0;
    let s = 1;
    for (let i = 1; i < sorted.length; i++) {
        if ((new Date(sorted[i-1]) - new Date(sorted[i])) / 86400000 === 1) s++;
        else break;
    }
    return s;
};

const getLast30Days = () => {
    const d = [];
    for (let i = 29; i >= 0; i--) {
        const x = new Date();
        x.setDate(x.getDate() - i);
        d.push(x.toISOString().split('T')[0]);
    }
    return d;
};

const getWeekDays = () => {
    const days = [], n = new Date(), dow = n.getDay(), mon = new Date(n);
    mon.setDate(n.getDate() - (dow === 0 ? 6 : dow - 1));
    for (let i = 0; i < 7; i++) {
        const d = new Date(mon);
        d.setDate(mon.getDate() + i);
        days.push({ date: d.toISOString().split('T')[0], label: ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'][i], isToday: d.toISOString().split('T')[0] === today() });
    }
    return days;
};

// === ICONS ===
const Icons = {
    Home: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
    Wallet: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
    Target: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
    Check: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
    Chart: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
    Heart: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
    FileText: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
    Settings: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10M4.22 4.22l4.24 4.24m7.08 7.08l4.24 4.24M1 12h6m6 0h10M4.22 19.78l4.24-4.24m7.08-7.08l4.24-4.24"/></svg>,
    Plus: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    CheckMark: () => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
};

// === COMPONENTS ===
const Modal = ({ open, onClose, title, children }) => {
    if (!open) return null;
    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-handle"/>
                <div className="modal-title">{title}</div>
                {children}
            </div>
        </div>
    );
};

const BarChart = ({ data }) => {
    const max = Math.max(...data.map(d => Math.max(d.income || 0, d.expense || 0)), 1);
    return (
        <div className="bar-chart">
            {data.map((d, i) => (
                <div key={i} className="bar-group">
                    <div className="bars">
                        <div className="bar income" style={{ height: `${((d.income || 0) / max) * 100}%` }}/>
                        <div className="bar expense" style={{ height: `${((d.expense || 0) / max) * 100}%` }}/>
                    </div>
                    <span className="bar-label">{d.label}</span>
                </div>
            ))}
        </div>
    );
};

const PieChart = ({ data }) => {
    const total = data.reduce((s, d) => s + d.value, 0);
    if (!total) return null;
    let angle = 0;
    const parts = data.map(d => { const a = (d.value / total) * 360, start = angle; angle += a; return `${d.color} ${start}deg ${angle}deg`; });
    return (
        <div className="pie-wrap">
            <div className="pie" style={{ background: `conic-gradient(${parts.join(', ')})` }}/>
            <div className="pie-legend">
                {data.slice(0, 5).map((d, i) => (
                    <div key={i} className="pie-item">
                        <div className="pie-color" style={{ background: d.color }}/><span>{d.emoji} {d.name}</span>
                        <span className="pie-pct">{((d.value / total) * 100).toFixed(0)}%</span>
                    </div>
                ))}
            </div>
        </div>
    );
};

// === BREATHING ===
const BreathingScreen = ({ onClose }) => {
    const [phase, setPhase] = useState('ready');
    const [running, setRunning] = useState(false);
    const [cycles, setCycles] = useState(0);
    const [pattern, setPattern] = useState([4, 4, 4, 4]);
    const phaseNames = ['–í–¥–æ—Ö', '–ó–∞–¥–µ—Ä–∂–∫–∞', '–í—ã–¥–æ—Ö', '–ó–∞–¥–µ—Ä–∂–∫–∞'];
    const phaseClasses = ['inhale', 'hold', 'exhale', 'hold'];
    const patterns = { '4-4-4-4': [4, 4, 4, 4], '4-7-8': [4, 7, 8, 0], '5-5': [5, 0, 5, 0] };

    useEffect(() => {
        if (!running) return;
        let phaseIdx = 0, timer = pattern[0];
        setPhase(phaseClasses[0]);
        
        const interval = setInterval(() => {
            timer--;
            if (timer <= 0) {
                phaseIdx = (phaseIdx + 1) % 4;
                while (pattern[phaseIdx] === 0) phaseIdx = (phaseIdx + 1) % 4;
                if (phaseIdx === 0) setCycles(c => c + 1);
                timer = pattern[phaseIdx];
                setPhase(phaseClasses[phaseIdx]);
            }
        }, 1000);
        
        return () => clearInterval(interval);
    }, [running, pattern]);

    return (
        <div className="breathing-screen">
            <button className="breathing-close" onClick={onClose}>√ó</button>
            <div className={`breathing-circle ${running ? phase : ''}`}>
                <span className="breathing-text">{running ? phaseNames[phaseClasses.indexOf(phase)] : '–ì–æ—Ç–æ–≤—ã?'}</span>
            </div>
            <p className="breathing-count">{cycles > 0 && `–¶–∏–∫–ª–æ–≤: ${cycles}`}</p>
            <div className="pattern-btns">
                {Object.entries(patterns).map(([name, p]) => (
                    <button key={name} className={`pattern-btn ${JSON.stringify(pattern) === JSON.stringify(p) ? 'active' : ''}`}
                        onClick={() => setPattern(p)}>{name}</button>
                ))}
            </div>
            <div className="breathing-controls">
                <button className="breathing-btn" onClick={() => { setRunning(!running); if (!running) setCycles(0); }}>
                    {running ? '–°—Ç–æ–ø' : '–°—Ç–∞—Ä—Ç'}
                </button>
            </div>
        </div>
    );
};

// === DASHBOARD ===
const Dashboard = ({ data, setTab, convertedBalances }) => {
    const main = data.settings?.mainCurrency || 'USD';
    
    const totalBalance = useMemo(() => {
        return (convertedBalances.accounts || 0) + (convertedBalances.investments || 0) + (convertedBalances.transactions || 0);
    }, [convertedBalances]);
    
    const monthStats = useMemo(() => {
        const start = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        const f = data.transactions.filter(t => new Date(t.date) >= start);
        return {
            income: f.filter(t => t.type === 'income').reduce((s, t) => s + (t.convertedAmount || t.amount), 0),
            expense: f.filter(t => t.type === 'expense').reduce((s, t) => s + (t.convertedAmount || t.amount), 0)
        };
    }, [data.transactions]);
    
    const todayHabits = data.habits.filter(h => h.completedDates?.includes(today())).length;
    const maxStreak = Math.max(0, ...data.habits.map(h => getStreak(h.completedDates)));
    const todayMood = data.moods?.find(m => m.date === today());
    const allCats = [...CATEGORIES.expense, ...CATEGORIES.income];
    const recent = [...data.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

    return (
        <div>
            <div className="header">
                <div className="header-title">Life Tracker</div>
                <div className="header-sub">{new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
            </div>
            
            <div className="card balance-card">
                <div className="balance-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                <div className="balance-amount">{formatAmount(totalBalance, main)}</div>
                <div className="balance-row">
                    <div className="balance-stat">
                        <div className="balance-stat-label">–î–æ—Ö–æ–¥ (–º–µ—Å)</div>
                        <div className="balance-stat-value">+{formatAmount(monthStats.income, main)}</div>
                    </div>
                    <div className="balance-stat">
                        <div className="balance-stat-label">–†–∞—Å—Ö–æ–¥ (–º–µ—Å)</div>
                        <div className="balance-stat-value">-{formatAmount(monthStats.expense, main)}</div>
                    </div>
                </div>
            </div>
            
            {maxStreak > 0 && (
                <div className="card" style={{ background: 'linear-gradient(135deg, #f59e0b 0%, #ef4444 100%)', border: 'none', display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ fontSize: '36px' }}>üî•</span>
                    <div>
                        <div style={{ fontSize: '24px', fontWeight: '800', color: 'white' }}>{maxStreak} –¥–Ω–µ–π</div>
                        <div style={{ fontSize: '13px', color: 'rgba(255,255,255,0.9)' }}>–õ—É—á—à–∞—è —Å–µ—Ä–∏—è!</div>
                    </div>
                </div>
            )}
            
            <div className="card">
                <div className="card-header"><span className="card-title">–°–µ–≥–æ–¥–Ω—è</span></div>
                <div className="stat-grid">
                    <div className="stat-card">
                        <div className="stat-label">–ü—Ä–∏–≤—ã—á–∫–∏</div>
                        <div className="stat-value">{todayHabits}/{data.habits.length}</div>
                    </div>
                    <div className="stat-card">
                        <div className="stat-label">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
                        <div className="stat-value">{todayMood ? MOODS.find(m => m.id === todayMood.mood)?.emoji : '‚Äî'}</div>
                    </div>
                </div>
            </div>
            
            <div className="card">
                <div className="card-header">
                    <span className="card-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</span>
                    <button className="btn btn-ghost" onClick={() => setTab('finance')}>–í—Å–µ</button>
                </div>
                {recent.length === 0 ? (
                    <div className="empty"><div className="empty-icon">üí∏</div><div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div></div>
                ) : recent.map(t => {
                    const cat = allCats.find(c => c.id === t.categoryId);
                    return (
                        <div key={t.id} className="list-item">
                            <div className="list-icon" style={{ background: cat?.color + '20' }}>{cat?.emoji || 'üìù'}</div>
                            <div className="list-info">
                                <div className="list-title">{t.description || cat?.name}</div>
                                <div className="list-sub">{formatDate(t.date)}</div>
                            </div>
                            <div className={`list-value ${t.type}`}>
                                {t.type === 'income' ? '+' : '-'}{formatAmount(t.amount, t.currency)}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

// === FINANCE TAB ===
const FinanceTab = ({ data, setData, refreshRates }) => {
    const [subTab, setSubTab] = useState('transactions');
    const [modal, setModal] = useState(null);
    const [editItem, setEditItem] = useState(null);
    const [type, setType] = useState('expense');
    const [loading, setLoading] = useState(false);
    const main = data.settings?.mainCurrency || 'USD';
    
    const [form, setForm] = useState({ amount: '', categoryId: '', description: '', currency: main, date: today() });
    const [accForm, setAccForm] = useState({ name: '', currency: 'USD', balance: '', icon: 'üí≥' });
    const [invForm, setInvForm] = useState({ name: '', currency: 'USD', balance: '', rate: '' });
    const [debtForm, setDebtForm] = useState({ name: '', total: '', remaining: '', rate: '', description: '' });

    const openEdit = (item, itemType) => {
        setEditItem({ ...item, itemType });
        if (itemType === 'transaction') {
            setType(item.type);
            setForm({ amount: item.amount.toString(), categoryId: item.categoryId, description: item.description || '', currency: item.currency, date: item.date });
        } else if (itemType === 'account') {
            setAccForm({ name: item.name, currency: item.currency, balance: item.balance.toString(), icon: item.icon });
        } else if (itemType === 'investment') {
            setInvForm({ name: item.name, currency: item.currency, balance: item.balance.toString(), rate: item.rate.toString() });
        } else if (itemType === 'debt') {
            setDebtForm({ name: item.name, total: item.total.toString(), remaining: item.remaining.toString(), rate: item.rate.toString(), description: item.description || '' });
        }
        setModal(itemType);
    };

    const saveTx = async () => {
        if (!form.amount || !form.categoryId) return;
        setLoading(true);
        
        const amount = parseFloat(form.amount);
        const converted = await CurrencyAPI.convert(amount, form.currency, main);
        
        const tx = { 
            id: editItem?.id || Date.now().toString(), 
            type, 
            amount, 
            convertedAmount: converted,
            categoryId: form.categoryId, 
            description: form.description, 
            currency: form.currency, 
            date: form.date 
        };
        
        const txs = editItem?.itemType === 'transaction' ? data.transactions.filter(t => t.id !== editItem.id) : data.transactions;
        setData({ ...data, transactions: [...txs, tx] });
        
        setLoading(false);
        setModal(null);
        setEditItem(null);
        setForm({ amount: '', categoryId: '', description: '', currency: main, date: today() });
        refreshRates();
    };

    const saveAcc = async () => {
        if (!accForm.name) return;
        const acc = { id: editItem?.id || Date.now().toString(), ...accForm, balance: parseFloat(accForm.balance) || 0 };
        const accs = editItem?.itemType === 'account' ? data.accounts.filter(a => a.id !== editItem.id) : data.accounts;
        setData({ ...data, accounts: [...accs, acc] });
        setModal(null);
        setEditItem(null);
        setAccForm({ name: '', currency: 'USD', balance: '', icon: 'üí≥' });
        refreshRates();
    };

    const saveInv = async () => {
        if (!invForm.name) return;
        const inv = { id: editItem?.id || Date.now().toString(), ...invForm, balance: parseFloat(invForm.balance) || 0, rate: parseFloat(invForm.rate) || 0 };
        const invs = editItem?.itemType === 'investment' ? (data.investments || []).filter(i => i.id !== editItem.id) : (data.investments || []);
        setData({ ...data, investments: [...invs, inv] });
        setModal(null);
        setEditItem(null);
        setInvForm({ name: '', currency: 'USD', balance: '', rate: '' });
        refreshRates();
    };

    const saveDebt = () => {
        if (!debtForm.name || !debtForm.total) return;
        const debt = { id: editItem?.id || Date.now().toString(), ...debtForm, total: parseFloat(debtForm.total), remaining: parseFloat(debtForm.remaining) || parseFloat(debtForm.total), rate: parseFloat(debtForm.rate) || 0 };
        const debts = editItem?.itemType === 'debt' ? (data.debts || []).filter(d => d.id !== editItem.id) : (data.debts || []);
        setData({ ...data, debts: [...debts, debt] });
        setModal(null);
        setEditItem(null);
        setDebtForm({ name: '', total: '', remaining: '', rate: '', description: '' });
    };

    const del = (id, type) => {
        if (type === 'transaction') setData({ ...data, transactions: data.transactions.filter(t => t.id !== id) });
        else if (type === 'account') setData({ ...data, accounts: data.accounts.filter(a => a.id !== id) });
        else if (type === 'investment') setData({ ...data, investments: (data.investments || []).filter(i => i.id !== id) });
        else if (type === 'debt') setData({ ...data, debts: (data.debts || []).filter(d => d.id !== id) });
        refreshRates();
    };

    const allCatsList = [...CATEGORIES.expense, ...CATEGORIES.income];

    return (
        <div>
            <div className="header"><div className="header-title">–§–∏–Ω–∞–Ω—Å—ã</div></div>
            
            <div className="tab-bar">
                {['transactions', 'accounts', 'investments', 'debts'].map(t => (
                    <button key={t} className={`tab-btn ${subTab === t ? 'active' : ''}`} onClick={() => setSubTab(t)}>
                        {t === 'transactions' ? 'üí∏ –û–ø–µ—Ä–∞—Ü–∏–∏' : t === 'accounts' ? 'üí≥ –°—á–µ—Ç–∞' : t === 'investments' ? 'üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏' : 'üí∞ –î–æ–ª–≥–∏'}
                    </button>
                ))}
            </div>

            {subTab === 'transactions' && (
                <div className="card">
                    <div className="card-header"><span className="card-title">–û–ø–µ—Ä–∞—Ü–∏–∏</span></div>
                    {data.transactions.length === 0 ? (
                        <div className="empty"><div className="empty-icon">üìä</div><div>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div></div>
                    ) : [...data.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).map(t => {
                        const cat = allCatsList.find(c => c.id === t.categoryId);
                        return (
                            <div key={t.id} className="list-item">
                                <div className="list-icon" style={{ background: cat?.color + '20' }}>{cat?.emoji || 'üìù'}</div>
                                <div className="list-info">
                                    <div className="list-title">{t.description || cat?.name}</div>
                                    <div className="list-sub">{formatDate(t.date)}</div>
                                </div>
                                <div className={`list-value ${t.type}`}>
                                    {t.type === 'income' ? '+' : '-'}{formatAmount(t.amount, t.currency)}
                                </div>
                                <div className="list-actions">
                                    <button className="action-btn" onClick={() => openEdit(t, 'transaction')}>‚úèÔ∏è</button>
                                    <button className="action-btn delete" onClick={() => del(t.id, 'transaction')}>üóëÔ∏è</button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}

            {subTab === 'accounts' && (
                <div className="card">
                    <div className="card-header">
                        <span className="card-title">–°—á–µ—Ç–∞</span>
                        <button className="btn btn-ghost" onClick={() => { setEditItem(null); setAccForm({ name: '', currency: 'USD', balance: '', icon: 'üí≥' }); setModal('account'); }}>+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    {data.accounts.length === 0 ? (
                        <div className="empty"><div className="empty-icon">üí≥</div><div>–ù–µ—Ç —Å—á–µ—Ç–æ–≤</div></div>
                    ) : data.accounts.map(a => (
                        <div key={a.id} className="list-item">
                            <div className="list-icon">{a.icon}</div>
                            <div className="list-info">
                                <div className="list-title">{a.name}</div>
                                <div className="list-sub">{a.currency}</div>
                            </div>
                            <div className="list-value">{formatAmount(a.balance, a.currency)}</div>
                            <div className="list-actions">
                                <button className="action-btn" onClick={() => openEdit(a, 'account')}>‚úèÔ∏è</button>
                                <button className="action-btn delete" onClick={() => del(a.id, 'account')}>üóëÔ∏è</button>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {subTab === 'investments' && (
                <div className="card">
                    <div className="card-header">
                        <span className="card-title">–ò–Ω–≤–µ—Å—Ç —Å—á–µ—Ç–∞</span>
                        <button className="btn btn-ghost" onClick={() => { setEditItem(null); setInvForm({ name: '', currency: 'USD', balance: '', rate: '' }); setModal('investment'); }}>+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    {(data.investments || []).length === 0 ? (
                        <div className="empty"><div className="empty-icon">üìà</div><div>–ù–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π</div></div>
                    ) : data.investments.map(i => (
                        <div key={i.id} className="list-item">
                            <div className="list-icon">üìà</div>
                            <div className="list-info">
                                <div className="list-title">{i.name}</div>
                                <div className="list-sub">{i.currency} ‚Ä¢ <span className="invest-rate">{i.rate}% –≥–æ–¥–æ–≤—ã—Ö</span></div>
                            </div>
                            <div className="list-value" style={{ color: 'var(--success)' }}>{formatAmount(i.balance, i.currency)}</div>
                            <div className="list-actions">
                                <button className="action-btn" onClick={() => openEdit(i, 'investment')}>‚úèÔ∏è</button>
                                <button className="action-btn delete" onClick={() => del(i.id, 'investment')}>üóëÔ∏è</button>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {subTab === 'debts' && (
                <div className="card">
                    <div className="card-header">
                        <span className="card-title">–î–æ–ª–≥–∏</span>
                        <button className="btn btn-ghost" onClick={() => { setEditItem(null); setDebtForm({ name: '', total: '', remaining: '', rate: '', description: '' }); setModal('debt'); }}>+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    {(data.debts || []).length === 0 ? (
                        <div className="empty"><div className="empty-icon">üí∞</div><div>–ù–µ—Ç –¥–æ–ª–≥–æ–≤</div></div>
                    ) : data.debts.map(d => (
                        <div key={d.id} style={{ padding: '12px 0', borderBottom: '1px solid var(--border)' }}>
                            <div className="list-item" style={{ padding: 0, border: 'none' }}>
                                <div className="list-icon">üí∞</div>
                                <div className="list-info">
                                    <div className="list-title">{d.name}</div>
                                    <div className="debt-tags">
                                        <span className="debt-tag">{d.rate}%</span>
                                        <span className="debt-tag">–í—Å–µ–≥–æ: {formatAmount(d.total, main)}</span>
                                    </div>
                                </div>
                                <div className="list-value" style={{ color: 'var(--danger)' }}>{formatAmount(d.remaining, main)}</div>
                                <div className="list-actions">
                                    <button className="action-btn" onClick={() => openEdit(d, 'debt')}>‚úèÔ∏è</button>
                                    <button className="action-btn delete" onClick={() => del(d.id, 'debt')}>üóëÔ∏è</button>
                                </div>
                            </div>
                            <div className="progress-bar" style={{ marginTop: '10px' }}>
                                <div className="progress-fill" style={{ width: `${((d.total - d.remaining) / d.total) * 100}%`, background: 'var(--success)' }}/>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            <button className="fab" onClick={() => { setEditItem(null); setForm({ amount: '', categoryId: '', description: '', currency: main, date: today() }); setModal('transaction'); }}>+</button>

            {/* Transaction Modal */}
            <Modal open={modal === 'transaction'} onClose={() => { setModal(null); setEditItem(null); }} title={editItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è'}>
                <div className="form-group">
                    <div className="toggle-group">
                        <button className={`toggle-btn ${type === 'expense' ? 'active' : ''}`} onClick={() => setType('expense')}>–†–∞—Å—Ö–æ–¥</button>
                        <button className={`toggle-btn ${type === 'income' ? 'active' : ''}`} onClick={() => setType('income')}>–î–æ—Ö–æ–¥</button>
                    </div>
                </div>
                <div className="form-group">
                    <label className="form-label">–°—É–º–º–∞</label>
                    <input type="number" className="form-input" placeholder="0.00" value={form.amount} onChange={e => setForm({ ...form, amount: e.target.value })} step="any"/>
                </div>
                <div className="form-group">
                    <label className="form-label">–í–∞–ª—é—Ç–∞</label>
                    <select className="form-input" value={form.currency} onChange={e => setForm({ ...form, currency: e.target.value })}>
                        <optgroup label="–§–∏–∞—Ç">{CURRENCIES.fiat.map(c => <option key={c.code} value={c.code}>{c.symbol} {c.code} ‚Äî {c.name}</option>)}</optgroup>
                        <optgroup label="–ö—Ä–∏–ø—Ç–æ">{CURRENCIES.crypto.map(c => <option key={c.code} value={c.code}>{c.symbol} {c.code} ‚Äî {c.name}</option>)}</optgroup>
                    </select>
                </div>
                <div className="form-group">
                    <label className="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <div className="cat-grid">
                        {CATEGORIES[type].map(c => (
                            <div key={c.id} className={`cat-item ${form.categoryId === c.id ? 'selected' : ''}`} onClick={() => setForm({ ...form, categoryId: c.id })}>
                                <span>{c.emoji}</span><span>{c.name}</span>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="form-group">
                    <label className="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" className="form-input" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" value={form.description} onChange={e => setForm({ ...form, description: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–î–∞—Ç–∞</label>
                    <input type="date" className="form-input" value={form.date} onChange={e => setForm({ ...form, date: e.target.value })}/>
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={saveTx} disabled={loading}>
                    {loading ? <div className="loading"/> : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
                </button>
            </Modal>

            {/* Account Modal */}
            <Modal open={modal === 'account'} onClose={() => { setModal(null); setEditItem(null); }} title={editItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á—ë—Ç' : '–ù–æ–≤—ã–π —Å—á—ë—Ç'}>
                <div className="form-group">
                    <label className="form-label">–ò–∫–æ–Ω–∫–∞</label>
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        {['üí≥','üíµ','üè¶','üí∞','üê∑','üíé','ü™ô','üìä'].map(i => (
                            <div key={i} className={`cat-item ${accForm.icon === i ? 'selected' : ''}`} style={{ width: '44px', padding: '10px' }} onClick={() => setAccForm({ ...accForm, icon: i })}>
                                <span style={{ fontSize: '20px' }}>{i}</span>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="form-group">
                    <label className="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" className="form-input" placeholder="–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞" value={accForm.name} onChange={e => setAccForm({ ...accForm, name: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–í–∞–ª—é—Ç–∞</label>
                    <select className="form-input" value={accForm.currency} onChange={e => setAccForm({ ...accForm, currency: e.target.value })}>
                        <optgroup label="–§–∏–∞—Ç">{CURRENCIES.fiat.map(c => <option key={c.code} value={c.code}>{c.symbol} {c.code}</option>)}</optgroup>
                        <optgroup label="–ö—Ä–∏–ø—Ç–æ">{CURRENCIES.crypto.map(c => <option key={c.code} value={c.code}>{c.symbol} {c.code}</option>)}</optgroup>
                    </select>
                </div>
                <div className="form-group">
                    <label className="form-label">–ë–∞–ª–∞–Ω—Å</label>
                    <input type="number" className="form-input" placeholder="0.00" value={accForm.balance} onChange={e => setAccForm({ ...accForm, balance: e.target.value })} step="any"/>
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={saveAcc}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </Modal>

            {/* Investment Modal */}
            <Modal open={modal === 'investment'} onClose={() => { setModal(null); setEditItem(null); }} title={editItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤—ã–π –∏–Ω–≤–µ—Å—Ç —Å—á—ë—Ç'}>
                <div className="form-group">
                    <label className="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" className="form-input" placeholder="–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π —Å—á—ë—Ç" value={invForm.name} onChange={e => setInvForm({ ...invForm, name: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–í–∞–ª—é—Ç–∞</label>
                    <select className="form-input" value={invForm.currency} onChange={e => setInvForm({ ...invForm, currency: e.target.value })}>
                        <optgroup label="–§–∏–∞—Ç">{CURRENCIES.fiat.map(c => <option key={c.code} value={c.code}>{c.symbol} {c.code}</option>)}</optgroup>
                        <optgroup label="–ö—Ä–∏–ø—Ç–æ">{CURRENCIES.crypto.map(c => <option key={c.code} value={c.code}>{c.symbol} {c.code}</option>)}</optgroup>
                    </select>
                </div>
                <div className="form-group">
                    <label className="form-label">–ë–∞–ª–∞–Ω—Å</label>
                    <input type="number" className="form-input" placeholder="0.00" value={invForm.balance} onChange={e => setInvForm({ ...invForm, balance: e.target.value })} step="any"/>
                </div>
                <div className="form-group">
                    <label className="form-label">–ì–æ–¥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ (%)</label>
                    <input type="number" className="form-input" placeholder="10" value={invForm.rate} onChange={e => setInvForm({ ...invForm, rate: e.target.value })}/>
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={saveInv}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </Modal>

            {/* Debt Modal */}
            <Modal open={modal === 'debt'} onClose={() => { setModal(null); setEditItem(null); }} title={editItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥' : '–ù–æ–≤—ã–π –¥–æ–ª–≥'}>
                <div className="form-group">
                    <label className="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" className="form-input" placeholder="–ò–ø–æ—Ç–µ–∫–∞" value={debtForm.name} onChange={e => setDebtForm({ ...debtForm, name: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–û–±—â–∞—è —Å—É–º–º–∞ –¥–æ–ª–≥–∞</label>
                    <input type="number" className="form-input" placeholder="1000000" value={debtForm.total} onChange={e => setDebtForm({ ...debtForm, total: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–û—Å—Ç–∞—Ç–æ–∫</label>
                    <input type="number" className="form-input" placeholder="800000" value={debtForm.remaining} onChange={e => setDebtForm({ ...debtForm, remaining: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (%)</label>
                    <input type="number" className="form-input" placeholder="12" value={debtForm.rate} onChange={e => setDebtForm({ ...debtForm, rate: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" className="form-input" placeholder="–ë–∞–Ω–∫, —É—Å–ª–æ–≤–∏—è..." value={debtForm.description} onChange={e => setDebtForm({ ...debtForm, description: e.target.value })}/>
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={saveDebt}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </Modal>
        </div>
    );
};

// === GOALS TAB ===
const GoalsTab = ({ data, setData }) => {
    const [modal, setModal] = useState(false);
    const [editItem, setEditItem] = useState(null);
    const main = data.settings?.mainCurrency || 'USD';
    const [form, setForm] = useState({ name: '', target: '', current: '', emoji: 'üéØ' });

    const openEdit = (goal) => {
        setEditItem(goal);
        setForm({ name: goal.name, target: goal.target.toString(), current: goal.current.toString(), emoji: goal.emoji });
        setModal(true);
    };

    const save = () => {
        if (!form.name || !form.target) return;
        const goal = { id: editItem?.id || Date.now().toString(), ...form, target: parseFloat(form.target), current: parseFloat(form.current) || 0 };
        const goals = editItem ? (data.goals || []).filter(g => g.id !== editItem.id) : (data.goals || []);
        setData({ ...data, goals: [...goals, goal] });
        setModal(false);
        setEditItem(null);
        setForm({ name: '', target: '', current: '', emoji: 'üéØ' });
    };

    const del = id => setData({ ...data, goals: (data.goals || []).filter(g => g.id !== id) });

    return (
        <div>
            <div className="header"><div className="header-title">–¶–µ–ª–∏</div><div className="header-sub">–ö–æ–ø–∏—Ç–µ –Ω–∞ –º–µ—á—Ç—É</div></div>
            
            <div className="card">
                <div className="card-header">
                    <span className="card-title">–ú–æ–∏ —Ü–µ–ª–∏</span>
                    <button className="btn btn-ghost" onClick={() => { setEditItem(null); setForm({ name: '', target: '', current: '', emoji: 'üéØ' }); setModal(true); }}>+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                {(data.goals || []).length === 0 ? (
                    <div className="empty"><div className="empty-icon">üéØ</div><div>–î–æ–±–∞–≤—å—Ç–µ —Ü–µ–ª—å</div></div>
                ) : data.goals.map(g => {
                    const pct = Math.min((g.current / g.target) * 100, 100);
                    return (
                        <div key={g.id} style={{ padding: '12px 0', borderBottom: '1px solid var(--border)' }}>
                            <div className="list-item" style={{ padding: 0, border: 'none' }}>
                                <div className="list-icon">{g.emoji}</div>
                                <div className="list-info">
                                    <div className="list-title">{g.name}</div>
                                    <div className="list-sub">{formatAmount(g.current, main)} / {formatAmount(g.target, main)}</div>
                                </div>
                                <span className="goal-pct">{pct.toFixed(0)}%</span>
                                <div className="list-actions">
                                    <button className="action-btn" onClick={() => openEdit(g)}>‚úèÔ∏è</button>
                                    <button className="action-btn delete" onClick={() => del(g.id)}>üóëÔ∏è</button>
                                </div>
                            </div>
                            <div className="progress-bar"><div className="progress-fill" style={{ width: `${pct}%` }}/></div>
                        </div>
                    );
                })}
            </div>

            <Modal open={modal} onClose={() => { setModal(false); setEditItem(null); }} title={editItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å' : '–ù–æ–≤–∞—è —Ü–µ–ª—å'}>
                <div className="form-group">
                    <label className="form-label">–≠–º–æ–¥–∑–∏</label>
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        {['üéØ','üè†','üöó','‚úàÔ∏è','üíª','üì±','üéì','üíç','üèùÔ∏è','üé∏','üíé','üéÆ'].map(e => (
                            <div key={e} className={`cat-item ${form.emoji === e ? 'selected' : ''}`} style={{ width: '44px', padding: '10px' }} onClick={() => setForm({ ...form, emoji: e })}>
                                <span style={{ fontSize: '20px' }}>{e}</span>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="form-group">
                    <label className="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" className="form-input" placeholder="–ù–∞ –º–∞—à–∏–Ω—É" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞</label>
                    <input type="number" className="form-input" placeholder="1000000" value={form.target} onChange={e => setForm({ ...form, target: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–£–∂–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ</label>
                    <input type="number" className="form-input" placeholder="0" value={form.current} onChange={e => setForm({ ...form, current: e.target.value })}/>
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </Modal>
        </div>
    );
};

// === HABITS TAB ===
const HabitsTab = ({ data, setData }) => {
    const [modal, setModal] = useState(false);
    const [editItem, setEditItem] = useState(null);
    const [form, setForm] = useState({ name: '', emoji: '‚úÖ' });
    const t = today();
    const todayMood = data.moods?.find(m => m.date === t);

    const openEdit = (habit) => {
        setEditItem(habit);
        setForm({ name: habit.name, emoji: habit.emoji });
        setModal(true);
    };

    const toggle = id => setData({ ...data, habits: data.habits.map(h => h.id === id ? { ...h, completedDates: h.completedDates?.includes(t) ? h.completedDates.filter(d => d !== t) : [...(h.completedDates || []), t] } : h) });
    const setMood = id => setData({ ...data, moods: [...(data.moods || []).filter(m => m.date !== t), { date: t, mood: id }] });
    
    const save = () => {
        if (!form.name) return;
        const habit = { id: editItem?.id || Date.now().toString(), ...form, completedDates: editItem?.completedDates || [] };
        const habits = editItem ? data.habits.filter(h => h.id !== editItem.id) : data.habits;
        setData({ ...data, habits: [...habits, habit] });
        setModal(false);
        setEditItem(null);
        setForm({ name: '', emoji: '‚úÖ' });
    };
    
    const del = id => setData({ ...data, habits: data.habits.filter(h => h.id !== id) });

    return (
        <div>
            <div className="header"><div className="header-title">–ü—Ä–∏–≤—ã—á–∫–∏</div></div>
            
            <div className="card">
                <div className="card-header"><span className="card-title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span></div>
                <div className="mood-row">
                    {MOODS.map(m => (
                        <div key={m.id} className={`mood-btn ${todayMood?.mood === m.id ? 'selected' : ''}`} onClick={() => setMood(m.id)}>{m.emoji}</div>
                    ))}
                </div>
            </div>
            
            <div className="card">
                <div className="card-header"><span className="card-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</span></div>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' }}>
                    {['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(d => (
                        <div key={d} style={{ fontSize: '10px', color: 'var(--text-muted)', textAlign: 'center', padding: '4px' }}>{d}</div>
                    ))}
                    {(() => { 
                        const days = getLast30Days();
                        const first = new Date(days[0]);
                        const offset = (first.getDay() + 6) % 7;
                        const cells = [];
                        for (let i = 0; i < offset; i++) {
                            cells.push(<div key={`empty-${i}`} style={{ aspectRatio: '1', background: 'transparent' }}/>);
                        }
                        days.forEach(d => {
                            const m = data.moods?.find(x => x.date === d);
                            const emoji = m ? MOODS.find(x => x.id === m.mood)?.emoji : '';
                            cells.push(
                                <div key={d} style={{ aspectRatio: '1', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', background: 'var(--bg-tertiary)', borderRadius: '6px' }}>
                                    {emoji}
                                </div>
                            );
                        });
                        return cells;
                    })()}
                </div>
            </div>
            
            <div className="card">
                <div className="card-header">
                    <span className="card-title">–ü—Ä–∏–≤—ã—á–∫–∏</span>
                    <button className="btn btn-ghost" onClick={() => { setEditItem(null); setForm({ name: '', emoji: '‚úÖ' }); setModal(true); }}>+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                {data.habits.length === 0 ? (
                    <div className="empty"><div className="empty-icon">üéØ</div><div>–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤—ã—á–∫—É</div></div>
                ) : data.habits.map(h => {
                    const done = h.completedDates?.includes(t);
                    const streak = getStreak(h.completedDates);
                    return (
                        <div key={h.id} className="list-item">
                            <div className={`habit-check ${done ? 'done' : ''}`} onClick={() => toggle(h.id)}>
                                <Icons.CheckMark/>
                            </div>
                            <div className="list-info">
                                <div className="list-title">{h.emoji} {h.name}</div>
                                {streak > 0 && <div className="streak">üî• {streak} –¥–Ω–µ–π</div>}
                            </div>
                            <div className="list-actions">
                                <button className="action-btn" onClick={() => openEdit(h)}>‚úèÔ∏è</button>
                                <button className="action-btn delete" onClick={() => del(h.id)}>üóëÔ∏è</button>
                            </div>
                        </div>
                    );
                })}
            </div>

            <Modal open={modal} onClose={() => { setModal(false); setEditItem(null); }} title={editItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞'}>
                <div className="form-group">
                    <label className="form-label">–≠–º–æ–¥–∑–∏</label>
                    <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        {['‚úÖ','üí™','üìö','üèÉ','üíß','üßò','üò¥','ü•ó','üíä','üéØ','‚úçÔ∏è','üé®'].map(e => (
                            <div key={e} className={`cat-item ${form.emoji === e ? 'selected' : ''}`} style={{ width: '44px', padding: '10px' }} onClick={() => setForm({ ...form, emoji: e })}>
                                <span style={{ fontSize: '20px' }}>{e}</span>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="form-group">
                    <label className="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" className="form-input" placeholder="–ú–µ–¥–∏—Ç–∞—Ü–∏—è 10 –º–∏–Ω" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })}/>
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </Modal>
        </div>
    );
};

// === ANALYTICS TAB ===
const AnalyticsTab = ({ data }) => {
    const [period, setPeriod] = useState('week');
    const main = data.settings?.mainCurrency || 'USD';
    
    const stats = useMemo(() => {
        const n = new Date();
        let start, days;
        if (period === 'week') { start = new Date(n.getTime() - 7 * 86400000); days = 7; }
        else if (period === 'month') { start = new Date(n.getTime() - 30 * 86400000); days = 30; }
        else { start = new Date(n.getTime() - 365 * 86400000); days = 365; }
        
        const f = data.transactions.filter(t => new Date(t.date) >= start);
        const income = f.filter(t => t.type === 'income').reduce((s, t) => s + (t.convertedAmount || t.amount), 0);
        const expense = f.filter(t => t.type === 'expense').reduce((s, t) => s + (t.convertedAmount || t.amount), 0);
        
        const catStats = {};
        f.filter(t => t.type === 'expense').forEach(t => { catStats[t.categoryId] = (catStats[t.categoryId] || 0) + (t.convertedAmount || t.amount); });
        
        const labels = period === 'week' ? ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'] : period === 'month' ? ['–ù1','–ù2','–ù3','–ù4'] : ['–Ø','–§','–ú','–ê','–ú','–ò','–ò','–ê','–°','–û','–ù','–î'];
        const chartData = [];
        
        if (period === 'week') {
            for (let i = 6; i >= 0; i--) {
                const d = new Date(n.getTime() - i * 86400000);
                const ds = d.toISOString().split('T')[0];
                const dt = f.filter(t => t.date === ds);
                chartData.push({
                    label: labels[(d.getDay() + 6) % 7],
                    income: dt.filter(t => t.type === 'income').reduce((s, t) => s + (t.convertedAmount || t.amount), 0),
                    expense: dt.filter(t => t.type === 'expense').reduce((s, t) => s + (t.convertedAmount || t.amount), 0)
                });
            }
        } else if (period === 'month') {
            for (let w = 3; w >= 0; w--) {
                const ws = new Date(n.getTime() - (w + 1) * 7 * 86400000);
                const we = new Date(n.getTime() - w * 7 * 86400000);
                const wt = f.filter(t => new Date(t.date) >= ws && new Date(t.date) < we);
                chartData.push({
                    label: labels[3 - w],
                    income: wt.filter(t => t.type === 'income').reduce((s, t) => s + (t.convertedAmount || t.amount), 0),
                    expense: wt.filter(t => t.type === 'expense').reduce((s, t) => s + (t.convertedAmount || t.amount), 0)
                });
            }
        } else {
            for (let m = 0; m < 12; m++) {
                const mt = f.filter(t => new Date(t.date).getMonth() === m);
                chartData.push({
                    label: labels[m],
                    income: mt.filter(t => t.type === 'income').reduce((s, t) => s + (t.convertedAmount || t.amount), 0),
                    expense: mt.filter(t => t.type === 'expense').reduce((s, t) => s + (t.convertedAmount || t.amount), 0)
                });
            }
        }
        
        const habitRate = data.habits.length > 0 ? data.habits.reduce((s, h) => s + ((h.completedDates || []).filter(d => new Date(d) >= start).length / days), 0) / data.habits.length * 100 : 0;
        
        return { income, expense, balance: income - expense, catStats, chartData, habitRate };
    }, [data, period]);
    
    const pieData = Object.entries(stats.catStats).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([id, val]) => {
        const c = CATEGORIES.expense.find(x => x.id === id);
        return { name: c?.name || '–î—Ä—É–≥–æ–µ', emoji: c?.emoji || 'üì¶', value: val, color: c?.color || '#64748b' };
    });

    return (
        <div>
            <div className="header"><div className="header-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div></div>
            
            <div className="period-btns">
                {['week', 'month', 'year'].map(p => (
                    <button key={p} className={`period-btn ${period === p ? 'active' : ''}`} onClick={() => setPeriod(p)}>
                        {p === 'week' ? '–ù–µ–¥–µ–ª—è' : p === 'month' ? '–ú–µ—Å—è—Ü' : '–ì–æ–¥'}
                    </button>
                ))}
            </div>
            
            <div className="card">
                <div className="stat-grid">
                    <div className="stat-card"><div className="stat-label">–î–æ—Ö–æ–¥—ã</div><div className="stat-value positive">+{formatAmount(stats.income, main)}</div></div>
                    <div className="stat-card"><div className="stat-label">–†–∞—Å—Ö–æ–¥—ã</div><div className="stat-value negative">-{formatAmount(stats.expense, main)}</div></div>
                    <div className="stat-card"><div className="stat-label">–ë–∞–ª–∞–Ω—Å</div><div className={`stat-value ${stats.balance >= 0 ? 'positive' : 'negative'}`}>{stats.balance >= 0 ? '+' : ''}{formatAmount(stats.balance, main)}</div></div>
                    <div className="stat-card"><div className="stat-label">–ü—Ä–∏–≤—ã—á–∫–∏</div><div className="stat-value">{stats.habitRate.toFixed(0)}%</div></div>
                </div>
            </div>
            
            {stats.chartData.length > 0 && (
                <div className="card">
                    <div className="card-header">
                        <span className="card-title">–î–∏–Ω–∞–º–∏–∫–∞</span>
                        <div style={{ display: 'flex', gap: '10px', fontSize: '10px' }}>
                            <span style={{ color: 'var(--success)' }}>‚óè –î–æ—Ö–æ–¥</span>
                            <span style={{ color: 'var(--danger)' }}>‚óè –†–∞—Å—Ö–æ–¥</span>
                        </div>
                    </div>
                    <BarChart data={stats.chartData}/>
                </div>
            )}
            
            {pieData.length > 0 && (
                <div className="card">
                    <div className="card-header"><span className="card-title">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</span></div>
                    <PieChart data={pieData}/>
                </div>
            )}
        </div>
    );
};

// === WELLNESS TAB ===
const WellnessTab = ({ data }) => {
    const [screen, setScreen] = useState(null);
    const [calc, setCalc] = useState({ principal: '', rate: '', years: '', monthly: '' });
    const main = data.settings?.mainCurrency || 'USD';

    const calcResult = useMemo(() => {
        const p = parseFloat(calc.principal) || 0;
        const r = (parseFloat(calc.rate) || 0) / 100;
        const t = parseFloat(calc.years) || 0;
        const m = parseFloat(calc.monthly) || 0;
        
        if (p === 0 && m === 0) return null;
        
        const n = 12;
        let total = p * Math.pow(1 + r / n, n * t);
        if (m > 0 && r > 0) {
            total += m * ((Math.pow(1 + r / n, n * t) - 1) / (r / n));
        } else if (m > 0) {
            total += m * 12 * t;
        }
        
        const invested = p + m * 12 * t;
        return { total, invested, profit: total - invested };
    }, [calc]);

    if (screen === 'breathing') return <BreathingScreen onClose={() => setScreen(null)}/>;

    return (
        <div>
            <div className="header"><div className="header-title">–ó–¥–æ—Ä–æ–≤—å–µ</div></div>
            
            <div className="card">
                <div className="card-header"><span className="card-title">–ü—Ä–∞–∫—Ç–∏–∫–∏</span></div>
                <button className="btn btn-secondary" style={{ width: '100%', padding: '24px', flexDirection: 'column' }} onClick={() => setScreen('breathing')}>
                    <span style={{ fontSize: '32px', marginBottom: '8px' }}>üå¨Ô∏è</span>
                    <span>–î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞</span>
                </button>
            </div>
            
            <div className="card">
                <div className="card-header"><span className="card-title">üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤</span></div>
                <div className="form-group">
                    <label className="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è —Å—É–º–º–∞</label>
                    <input type="number" className="form-input" placeholder="10000" value={calc.principal} onChange={e => setCalc({ ...calc, principal: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–ï–∂–µ–º–µ—Å—è—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</label>
                    <input type="number" className="form-input" placeholder="1000" value={calc.monthly} onChange={e => setCalc({ ...calc, monthly: e.target.value })}/>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                    <div className="form-group">
                        <label className="form-label">–ì–æ–¥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ (%)</label>
                        <input type="number" className="form-input" placeholder="10" value={calc.rate} onChange={e => setCalc({ ...calc, rate: e.target.value })}/>
                    </div>
                    <div className="form-group">
                        <label className="form-label">–°—Ä–æ–∫ (–ª–µ—Ç)</label>
                        <input type="number" className="form-input" placeholder="5" value={calc.years} onChange={e => setCalc({ ...calc, years: e.target.value })}/>
                    </div>
                </div>
                
                {calcResult && (
                    <div className="calc-result">
                        <div className="calc-result-value">{formatAmount(calcResult.total, main)}</div>
                        <div className="calc-result-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</div>
                        <div className="calc-breakdown">
                            <div className="stat-card"><div className="stat-label">–í–ª–æ–∂–µ–Ω–æ</div><div className="stat-value">{formatAmount(calcResult.invested, main)}</div></div>
                            <div className="stat-card"><div className="stat-label">–ü—Ä–∏–±—ã–ª—å</div><div className="stat-value positive">+{formatAmount(calcResult.profit, main)}</div></div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// === NOTES TAB ===
const NotesTab = ({ data, setData }) => {
    const [modal, setModal] = useState(false);
    const [editItem, setEditItem] = useState(null);
    const [form, setForm] = useState({ title: '', content: '' });
    const [viewNote, setViewNote] = useState(null);

    const openEdit = (note) => {
        setEditItem(note);
        setForm({ title: note.title, content: note.content });
        setModal(true);
    };

    const save = () => {
        if (!form.content) return;
        const note = { 
            id: editItem?.id || Date.now().toString(), 
            title: form.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
            content: form.content,
            createdAt: editItem?.createdAt || now(),
            updatedAt: now()
        };
        const notes = editItem ? (data.notes || []).filter(n => n.id !== editItem.id) : (data.notes || []);
        setData({ ...data, notes: [note, ...notes] });
        setModal(false);
        setEditItem(null);
        setForm({ title: '', content: '' });
    };

    const del = id => setData({ ...data, notes: (data.notes || []).filter(n => n.id !== id) });

    if (viewNote) {
        const note = (data.notes || []).find(n => n.id === viewNote);
        if (!note) { setViewNote(null); return null; }
        return (
            <div>
                <div className="header">
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <button className="btn btn-ghost" style={{ padding: '8px' }} onClick={() => setViewNote(null)}>‚Üê</button>
                        <div className="header-title">{note.title}</div>
                    </div>
                </div>
                <div className="card">
                    <div style={{ whiteSpace: 'pre-wrap', lineHeight: '1.6' }}>{note.content}</div>
                    <div style={{ marginTop: '16px', fontSize: '12px', color: 'var(--text-muted)' }}>
                        –°–æ–∑–¥–∞–Ω–æ: {formatFullDate(note.createdAt)}
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '8px', padding: '0 16px' }}>
                    <button className="btn btn-secondary" style={{ flex: 1 }} onClick={() => { openEdit(note); setViewNote(null); }}>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button className="btn btn-danger" onClick={() => { del(note.id); setViewNote(null); }}>üóëÔ∏è</button>
                </div>
            </div>
        );
    }

    return (
        <div>
            <div className="header"><div className="header-title">–ó–∞–º–µ—Ç–∫–∏</div><div className="header-sub">–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –º—ã—Å–ª–∏</div></div>
            
            <div className="card">
                {(data.notes || []).length === 0 ? (
                    <div className="empty"><div className="empty-icon">üìù</div><div>–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div></div>
                ) : (data.notes || []).map(n => (
                    <div key={n.id} className="note-card" onClick={() => setViewNote(n.id)}>
                        <div className="note-title">{n.title}</div>
                        <div className="note-preview">{n.content}</div>
                        <div className="note-date">{formatFullDate(n.createdAt)}</div>
                    </div>
                ))}
            </div>

            <button className="fab" onClick={() => { setEditItem(null); setForm({ title: '', content: '' }); setModal(true); }}>+</button>

            <Modal open={modal} onClose={() => { setModal(false); setEditItem(null); }} title={editItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞'}>
                <div className="form-group">
                    <label className="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" className="form-input" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" value={form.title} onChange={e => setForm({ ...form, title: e.target.value })}/>
                </div>
                <div className="form-group">
                    <label className="form-label">–¢–µ–∫—Å—Ç</label>
                    <textarea className="form-input form-textarea" placeholder="–í–∞—à–∞ –∑–∞–º–µ—Ç–∫–∞..." value={form.content} onChange={e => setForm({ ...form, content: e.target.value })}/>
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </Modal>
        </div>
    );
};

// === SETTINGS TAB ===
const SettingsTab = ({ data, setData, isDark, setIsDark }) => {
    const exportData = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
        a.download = 'life-tracker-backup.json';
        a.click();
    };
    
    const clearData = () => {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
            setData({ accounts: [], transactions: [], habits: [], moods: [], goals: [], investments: [], debts: [], notes: [], settings: { mainCurrency: 'USD' } });
        }
    };

    return (
        <div>
            <div className="header"><div className="header-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div></div>
            
            <div className="card">
                <div className="settings-row">
                    <span className="settings-label">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                    <div className={`toggle-switch ${isDark ? 'on' : ''}`} onClick={() => setIsDark(!isDark)}/>
                </div>
            </div>
            
            <div className="card">
                <div className="card-header"><span className="card-title">–û—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞</span></div>
                <select className="form-input" value={data.settings?.mainCurrency || 'USD'} onChange={e => setData({ ...data, settings: { ...data.settings, mainCurrency: e.target.value } })}>
                    {CURRENCIES.fiat.map(c => <option key={c.code} value={c.code}>{c.symbol} {c.code} ‚Äî {c.name}</option>)}
                </select>
            </div>
            
            <div className="card">
                <button className="btn btn-secondary" style={{ width: '100%', marginBottom: '10px' }} onClick={exportData}>üì¶ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                <button className="btn btn-danger" style={{ width: '100%' }} onClick={clearData}>üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>
            
            <div className="card" style={{ textAlign: 'center', color: 'var(--text-muted)' }}>
                <div style={{ fontSize: '14px', fontWeight: '600' }}>Life Tracker</div>
                <div style={{ fontSize: '12px', marginTop: '4px' }}>Alpha 1.2</div>
            </div>
        </div>
    );
};

// === MAIN APP ===
const App = () => {
    const [tab, setTab] = useState('home');
    const [isDark, setIsDark] = useState(false);
    const [data, setData] = useState({ accounts: [], transactions: [], habits: [], moods: [], goals: [], investments: [], debts: [], notes: [], settings: { mainCurrency: 'USD' } });
    const [loaded, setLoaded] = useState(false);
    const [convertedBalances, setConvertedBalances] = useState({ accounts: 0, investments: 0, transactions: 0 });

    // Calculate converted balances
    const refreshRates = useCallback(async () => {
        const main = data.settings?.mainCurrency || 'USD';
        
        // Convert accounts
        let accTotal = 0;
        for (const acc of data.accounts) {
            const converted = await CurrencyAPI.convert(acc.balance, acc.currency, main);
            accTotal += converted;
        }
        
        // Convert investments
        let invTotal = 0;
        for (const inv of (data.investments || [])) {
            const converted = await CurrencyAPI.convert(inv.balance, inv.currency, main);
            invTotal += converted;
        }
        
        // Transactions balance
        const txTotal = data.transactions.reduce((s, t) => s + (t.type === 'income' ? 1 : -1) * (t.convertedAmount || t.amount), 0);
        
        setConvertedBalances({ accounts: accTotal, investments: invTotal, transactions: txTotal });
    }, [data]);

    useEffect(() => {
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            setIsDark(window.Telegram.WebApp.colorScheme === 'dark');
        }
        CurrencyAPI.fetchRates();
    }, []);
    
    useEffect(() => {
        (async () => {
            const saved = await storage.get();
            if (saved) setData(saved);
            setLoaded(true);
        })();
    }, []);
    
    useEffect(() => {
        if (loaded) {
            storage.set(data);
            refreshRates();
        }
    }, [data, loaded]);
    
    useEffect(() => {
        document.body.className = isDark ? '' : 'light-theme';
    }, [isDark]);

    if (!loaded) {
        return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh' }}><div className="loading"/></div>;
    }

    return (
        <div className="app">
            {tab === 'home' && <Dashboard data={data} setTab={setTab} convertedBalances={convertedBalances}/>}
            {tab === 'finance' && <FinanceTab data={data} setData={setData} refreshRates={refreshRates}/>}
            {tab === 'goals' && <GoalsTab data={data} setData={setData}/>}
            {tab === 'habits' && <HabitsTab data={data} setData={setData}/>}
            {tab === 'analytics' && <AnalyticsTab data={data}/>}
            {tab === 'wellness' && <WellnessTab data={data}/>}
            {tab === 'notes' && <NotesTab data={data} setData={setData}/>}
            {tab === 'settings' && <SettingsTab data={data} setData={setData} isDark={isDark} setIsDark={setIsDark}/>}
            
            <nav className="nav">
                {[
                    { id: 'home', icon: Icons.Home, label: '–ì–ª–∞–≤–Ω–∞—è' },
                    { id: 'finance', icon: Icons.Wallet, label: '–§–∏–Ω–∞–Ω—Å—ã' },
                    { id: 'goals', icon: Icons.Target, label: '–¶–µ–ª–∏' },
                    { id: 'habits', icon: Icons.Check, label: '–ü—Ä–∏–≤—ã—á–∫–∏' },
                    { id: 'analytics', icon: Icons.Chart, label: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' },
                    { id: 'wellness', icon: Icons.Heart, label: '–ó–¥–æ—Ä–æ–≤—å–µ' },
                    { id: 'notes', icon: Icons.FileText, label: '–ó–∞–º–µ—Ç–∫–∏' },
                    { id: 'settings', icon: Icons.Settings, label: '–ï—â—ë' },
                ].map(t => (
                    <div key={t.id} className={`nav-item ${tab === t.id ? 'active' : ''}`} onClick={() => setTab(t.id)}>
                        <t.icon/><span>{t.label}</span>
                    </div>
                ))}
            </nav>
        </div>
    );
};

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
</body>
</html>
